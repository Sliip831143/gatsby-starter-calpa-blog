---
slug: 2020-01-30-gulp 動かないメモ
title: gulp 動かないメモ
date: 2020-01-30T10:53:51.005Z
description: リモートからプルしたプロジェクトの gulp が動かない…。 Windows / Mac 別対処メモ
tags:
  - gulp.js
headerImage: 'https://imgur.com/56MGZrz.png'
templateKey: blog-post
---
## gulp が動かない
---
　gulp が動かない。バージョンは 3.9.1 。

　入社時与えられた Windows PC が早くも不調を訴え出し、ようやく愛着が湧き始めた所だというのに呆気なく買い替えが決まってしまいました。いつその時が来ても良いよう、別途支給されていた MacBook の開発環境を整えにかかったのですが、リモートからローカルにプルしてパッケージまでインストールしたプロジェクトの gulp コマンドが転ける転ける。

　ひーこら言いながらなんとか動くようになった矢先に新 Windows PC が届いたので、待ってましたとばかりにこちらも環境をこしらえにかかったのですが、やっぱり gulp に悪戦苦闘。

　入社して間も無いんだから勝手覚えておけよと言われたらぐうの音も出ません。正直「環境構築なんて一回やってしまえば当分やらんだろうし、次やる時はそん時の自分が何とかしてくれるっしょ」と舐めに舐め腐っておりました。案の定何とかせざるを得ない羽目に陥りどうにかなってしまいそうだったので、戒めに詰まった所とその対処を時系列に並べて書き残しておきたいと思います。

　プロジェクトをガーっとプルしてパッケージをビーっとインストールして gulp バーンと叩けば動くと本気で思ってた。早く死にたい。
<br>
<br>

## package.json の dependencies
---
　下記の通り。

```
"dependencies": {
  "browser-sync": "^2.6.4",
  "gulp": "^3.9.1",
  "gulp-compass": "^2.0.4",
  "gulp-concat": "^2.5.2",
  "gulp-ejs": "^1.1.0",
  "gulp-if": "^1.2.5",
  "gulp-imagemin": "^2.2.1",
  "gulp-notify": "^2.2.0",
  "gulp-pleeease": "^1.2.0",
  "gulp-plumber": "^1.0.0",
  "gulp-sass": "^2.0.0",
  "gulp-uglify": "^1.1.0"
}
```
<br>
<br>

## macOS Catalina の場合

　予め Homebrew 及び nodebrew、Yarn を導入しておきます。手順については割愛しますが、Yarn を Homebrew 経由で導入しないよう注意。Homebrew で Yarn を導入してしまうと、一緒に node を引き連れてきた挙句 Path を上書きしてしまう為、事実上 nodebrew による node のバージョン切り替えが利かなくなってしまいます（ハマった）。
　Homebrew → nodebrew → npm で Yarn 導入と踏むのが吉。

（参考：
[最近流行りのyarnをインストールしたらハマった話](https://hisa-tech.site/yarn-install-stumble/)）
<br>

---
### 1. gulp: command not found

　gulp コマンドを実行したら下記エラーが出力され失敗。

```
gulp: command not found
```


#### 対処： Path を通す

　/Users/ [ ユーザー名 ] /.bash_profile（ファイルが存在しなければ新規作成）に下記 Path  を追記。

```
export PATH=$PATH:./node_modules/.bin
```


### 2. primordials が未定義

　再度 gulp を実行するも下記エラーで失敗。

```
fs.js:27
const { Math, Object, Reflect } = primordials;
                                  ^

ReferenceError: primordials is not defined
```


#### 対処： Node.js のバージョンを v11 系に切り替え

　内部 API の変更により、node の v12 系 の上で gulp の v3 系は動かないとの事。 ```node -v``` で node のバージョンを確認した所、v12.31.1 と v12 系だった。
これに対応するには gulp を v4 系にバージョンアップする必要があるが、「package-lock.json」で利用パッケージのバージョンを指定されている都合上そうもいかない。

　従って node を v11 系以下にダウングレードする必要がある。nodebrew を導入しているので、これによってバージョンを v11 系最新の v11.15.0 に切り替える。

　node の v11.15.0 をインストール。

```
nodebrew install v11.15.0
```

　node のバージョンを切り替え。

```
nodebrew use v11.15.0
```


### 3. Error: Cannot find module 'gulp-sass'

　三度 gulp を実行するも下記エラーで失敗。

```
internal/modules/cjs/loader.js:670
    throw err;
    ^

Error: Cannot find module 'gulp-sass'
```

　```npm ls --depth=0``` でインストール済みのパッケージを確認してみると確かに gulp-sass がエラーを出している。

```
npm ERR! missing: gulp-sass@^2.0.0, required by module@1.0.0
```


#### 対処： gulp-sass の再インストール

　gulp-sass をアンインストール

```
npm uninstall gulp-sass --save
```
※ インストール先が devDependencies の場合、オプションは ```--save-dev``` 。

　念のため npm のキャッシュをクリア

```
sudo npm cache clean --force
```

　再度 gulp-sass をインストール

```
npm i gulp-sass@2.0.0
```

　結果、gulp-sass のエラーが解消され、gulp も動くようになりました。良かったー。
<br>
<br>

## Windows 10 の場合
